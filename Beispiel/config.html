{% extends '_base.html' %}

{% block title %}DDC Configuration{% endblock %}

{% block content %}
    <div class="text-center logo-header">
        <img src="{{ url_for('static', filename='ddc_web.png') }}" alt="DDC Logo">
        <div class="ddc-title">
            <span class="neon-text-large" id="neon-ddc">DDC</span>
        </div>
    </div>
    <h2 class="text-center my-3">DockerDiscordControl</h2>
    <p class="text-center lead" style="color:#adb5bd;">Configure your DDC Bot here.</p>

    {# Donation Section - Only show if not disabled by key #}
    {% if not donations_disabled %}
    <div class="text-center my-4 donation-section" id="donationSection">
        <p style="color:#adb5bd; margin-bottom: 10px;">If you find DDC helpful, consider supporting its development:</p>
        <span class="d-inline-block mx-2 align-middle">
            <a href="https://buymeacoffee.com/dockerdiscordcontrol" target="_blank" rel="noopener noreferrer" class="bmc-button donation-button" data-donation-type="coffee" title="Buy Me A Coffee">
                <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 40px !important; width: auto !important;">
            </a>
        </span>
        <span class="d-inline-block mx-2 align-middle">
            <a href="https://www.paypal.com/donate/?hosted_button_id=XKVC6SFXU2GW4" target="_blank" rel="noopener noreferrer" class="btn btn-sm donation-button" data-donation-type="paypal" style="background-color: #0070ba; border-color: #0070ba; color: white; height: 40px; line-height: 28px;" title="Donate with PayPal">
               <i class="bi bi-paypal"></i> Donate with PayPal
            </a>
        </span>
        
        
        <!-- Mech Power Call-to-Action -->
        <div class="text-center mb-3">
            <p style="color:#adb5bd; margin-bottom: 10px;">‚ö° Power the Mech with your donations to bring it to life!</p>
        </div>
        
        <!-- Donator Mech Animation - Below buttons -->
        <div class="w-100 mt-3">
            <div class="donator-mech-container d-flex align-items-center" title="Donation Mech Status">
                <!-- Left side: Mech + Speed -->
                <div class="mech-section d-flex flex-column align-items-center">
                    <div id="donatorMech" class="mech-display">
                        <img id="donatorMechAnimation" src="/mech_animation" alt="Mech" style="max-height: 100px; max-width: 200px; width: auto; height: auto;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=&quot;width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; font-size: 48px; color: #666;&quot;>ü§ñ</div>'">
                        <div class="mech-loading" style="display: none;">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="powerConsumptionOverlay" class="power-consumption-overlay">-$0.00003472</div>
                        <div id="speedStatusOverlay" class="speed-status-overlay">OFFLINE</div>
                    </div>
                </div>
                
                <!-- Right side: Gauge Container -->
                <div class="gauge-container">
                    
                    <!-- Power Bar -->
                    <div class="bar-row">
                        <div class="bar-wrapper">
                            <div class="power-bar">
                                <div id="powerLevel" class="power-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="bar-label">
                            <span style="display: flex; flex-direction: column; justify-content: center; height: 100%;">
                                <span style="color: #ff4444; font-weight: bold;">POWER</span>
                                <span id="powerAmount" style="color: #ffaa00; font-weight: bold;">0</span>
                            </span>
                        </div>
                    </div>
                    
                    <!-- Evolution Bar -->
                    <div class="bar-row">
                        <div class="bar-wrapper">
                            <div class="evolution-bar">
                                <div id="evolutionProgress" class="evolution-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="bar-label">
                            <span id="nextEvolutionInfo" style="color: #888; font-size: 11px; display: flex; flex-direction: column; justify-content: center; height: 100%;">
                                <span id="nextEvolutionName" style="color: #aaa;">REPAIRED MECH</span>
                                <span id="nextEvolutionAmount" style="color: #ffcc00; font-weight: bold;">$20 needed</span>
                            </span>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
        
        {# Matrix Terminal Thank You Overlay - Hidden by default #}
        <div id="thankYouOverlay" class="matrix-terminal-overlay" style="display: none;">
            <div class="terminal-content">
                <div class="terminal-text">
                    <span id="thankYouText"></span>
                    <span id="cursor" class="cursor">_</span>
                </div>
            </div>
        </div>

        {# Donation Input Modal - Hidden by default #}
        <div id="donationModal" class="donation-modal-overlay" style="display: none;">
            <div class="donation-modal">
                <div class="donation-modal-header">
                    <h4>üéâ Thank you for your donation!</h4>
                    <p>Please enter your donation details to power the mech:</p>
                </div>
                <div class="donation-modal-body">
                    <form id="donationForm">
                        <div class="form-group">
                            <label for="donationAmount" id="donationAmountLabel">Donation Amount ($)</label>
                            <input type="number" id="donationAmount" class="form-control" min="0.01" step="0.01" placeholder="5.00" required>
                        </div>
                        <div class="form-group">
                            <label for="donorName" id="donorNameLabel">Donor Name (optional)</label>
                            <input type="text" id="donorName" class="form-control" placeholder="Anonymous" maxlength="50">
                        </div>
                        <div class="form-group">
                            <div class="form-check">
                                <input type="checkbox" id="publishToDiscord" class="form-check-input" checked>
                                <label for="publishToDiscord" class="form-check-label" id="publishToDiscordLabel">
                                    Announce donation in Discord channels
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="donation-modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeDonationModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitDonation()">üöÄ ‚ö° Power the Mech!</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %} {# End donations_disabled check #}

    <style>
        /* Donation Button Animations */
        .donation-button {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .donation-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .donation-button:active {
            transform: scale(0.95);
        }

        /* MATRIX TERMINAL OVERLAY */
        .matrix-terminal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000000;
            z-index: 2500;
            display: block;
            font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
            animation: terminalFadeIn 0.3s ease-out;
            overflow: hidden;
        }
        
        @keyframes terminalFadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        .terminal-content {
            padding: 20px;
            width: 100%;
            height: 100%;
        }
        
        .terminal-text {
            color: #00ff00;
            font-size: 18px;
            font-weight: bold;
            line-height: 1.2;
            text-align: left;
        }
        
        .cursor {
            color: #00ff00;
            font-size: 18px;
            font-weight: bold;
            animation: cursorBlink 1s infinite;
        }
        
        @keyframes cursorBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Matrix Terminal Complete */
        
        /* Donator Mech Status */
        .donator-mech-container {
            padding: 16px;
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            max-width: 620px;
            margin: 0 auto;
            min-height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mech-section {
            min-width: 180px;
            margin-right: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .mech-display {
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 4px;
        }
        
        .power-consumption-overlay {
            position: absolute;
            top: 2px;
            right: 2px;
            background: transparent;
            color: #ff4444;
            font-size: 11px;
            font-weight: bold;
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            text-align: center;
        }
        
        .speed-status-overlay {
            position: absolute;
            top: 2px;
            left: 2px;
            background: transparent;
            color: #888888;
            font-size: 10px;
            font-weight: bold;
            z-index: 10;
            pointer-events: none;
            text-align: left;
            max-width: 120px;
            word-wrap: break-word;
            line-height: 1.1;
        }
        
        /* Donation Modal Styles */
        .donation-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: modalFadeIn 0.3s ease;
        }
        
        .donation-modal {
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.4s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
        }
        
        .donation-modal-header {
            padding: 20px 20px 10px;
            border-bottom: 1px solid #333;
            text-align: center;
        }
        
        .donation-modal-header h4 {
            color: #ffcc00;
            margin: 0 0 10px 0;
            font-size: 1.4em;
        }
        
        .donation-modal-header p {
            color: #adb5bd;
            margin: 0;
            font-size: 0.95em;
        }
        
        .donation-modal-body {
            padding: 20px;
        }
        
        .donation-modal-footer {
            padding: 10px 20px 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .donation-modal .form-group {
            margin-bottom: 18px;
        }
        
        .donation-modal label {
            display: block;
            color: #fff;
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .donation-modal .form-control {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            color: #fff;
            padding: 10px 12px;
            font-size: 0.95em;
            width: 100%;
            transition: border-color 0.2s;
        }
        
        .donation-modal .form-control:focus {
            outline: none;
            border-color: #ffcc00;
            box-shadow: 0 0 0 2px rgba(255, 204, 0, 0.2);
        }
        
        .donation-modal .form-check {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .donation-modal .form-check-input {
            width: 18px;
            height: 18px;
            margin: 0;
        }
        
        .donation-modal .form-check-label {
            color: #adb5bd;
            margin: 0;
            font-size: 0.9em;
            cursor: pointer;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalSlideIn {
            from { transform: scale(0.9) translateY(-20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .gauge-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 320px;
            flex: 1;
            gap: 16px;
            height: 120px;
        }
        
        .bar-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .bar-wrapper {
            flex: 0 0 150px;
            margin-right: 0;
        }
        
        .bar-label {
            flex: 0 0 auto;
            font-size: 11px;
            white-space: nowrap;
            margin-left: 0;
        }
        
        .power-bar, .evolution-bar {
            width: 150px;
            height: 28px;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .power-fill {
            height: 100%;
            background: linear-gradient(90deg, #cc0000 0%, #ff3333 50%, #ff6666 100%);
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
        }
        
        .evolution-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700 0%, #ffed4e 25%, #c0c0c0 50%, #ffed4e 75%, #ffd700 100%);
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
        }
        
        .evolution-name {
            font-size: 11px;
            font-weight: bold;
            color: #cc00ff;
            text-align: center;
            text-shadow: 0 0 3px rgba(204, 0, 255, 0.5);
        }
        
        .next-evolution-info {
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px dotted #444;
        }
        
        .Power-amount {
            font-size: 14px;
            font-weight: bold;
            color: #ffcc00;
            margin-top: 4px;
            text-align: center;
            text-shadow: 0 0 5px rgba(255, 204, 0, 0.5);
        }
        
        /* Gray state (inactive/old donation) - NO PULSE */
        .donator-heart.inactive {
            color: #6c757d;
            text-shadow: none;
            animation: none; /* No pulsing when inactive */
        }
        
        /* Neon active state (recent donation) - animation set by JavaScript */
        .donator-heart.active {
            color: #36cfff;
            text-shadow: 0 0 10px #36cfff, 0 0 20px #36cfff, 0 0 40px #36cfff;
            /* Animation set dynamically by JavaScript */
        }
        
        /* Fading state - NO PULSE, color set by JavaScript */
        .donator-heart.fading {
            animation: none; /* No pulsing during fade */
            /* Color and text-shadow set dynamically by JavaScript */
        }
        
        /* Dynamic heart pulse animations - generated by JavaScript */
        @keyframes heartPulseFast {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }
        
        @keyframes heartPulseMedium {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes heartPulseSlow {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }
        
        @keyframes heartPulseVerySlow {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .terminal-text, .cursor { 
                font-size: 14px; 
            }
            .terminal-content {
                padding: 15px;
            }
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const donationButtons = document.querySelectorAll('.donation-button');
            const thankYouOverlay = document.getElementById('thankYouOverlay');
            const donatorHeart = document.getElementById('donatorHeart');
            
            donationButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    const donationType = this.getAttribute('data-donation-type');
                    console.info('üí∞ [MATRIX] Donation button clicked:', donationType, 'from button:', this);
                    
                    // Record donation click to server
                    fetch('/api/donation/click', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            type: donationType
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Store for thank you display
                            const donationClickData = {
                                type: donationType,
                                timestamp: Date.now() // Use milliseconds for easier comparison
                            };
                            localStorage.setItem('ddcDonationClick', JSON.stringify(donationClickData));
                            console.info('üí∞ [MATRIX] Donation button clicked, data stored:', donationClickData);
                            
                            // Update mech immediately
                            // Use new efficient Power system instead
                            syncWithServer();
                        } else {
                            console.error('üí∞ [MATRIX] Donation click recording failed:', data);
                        }
                    })
                    .catch(error => {
                        console.error('üí∞ [MATRIX] Error recording donation click:', error);
                    });
                    
                    // Allow normal link behavior (open in new tab)
                    // No e.preventDefault() - let the browser handle the link normally
                });
            });
            
            // Check for donation return on page focus/load
            let isProcessingDonationReturn = false;
            function checkForDonationReturn() {
                console.info('üîç [MATRIX] checkForDonationReturn called');
                if (isProcessingDonationReturn) {
                    console.info('üîç [MATRIX] Already processing, returning');
                    return; // Prevent multiple simultaneous calls
                }
                
                const donationData = localStorage.getItem('ddcDonationClick');
                console.info('üîç [MATRIX] localStorage data:', donationData);
                if (donationData) {
                    try {
                        isProcessingDonationReturn = true;
                        const data = JSON.parse(donationData);
                        const timeSinceClick = Date.now() - data.timestamp;
                        
                        console.info('üîç [MATRIX] Time since click:', timeSinceClick, 'ms (', Math.round(timeSinceClick/1000), 'seconds )');
                        // Show thank you if donation was clicked within last 60 minutes
                        if (timeSinceClick < 60 * 60 * 1000) {
                            // Mark as shown with timestamp to prevent multiple shows of SAME click
                            const shownKey = `ddcDonationShown_${data.timestamp}`;
                            console.info('üîç [MATRIX] Checking if already shown:', shownKey);
                            
                            const alreadyShown = localStorage.getItem(shownKey);
                            console.info('üîç [MATRIX] Already shown result:', alreadyShown);
                            
                            if (!alreadyShown) {
                                console.info('‚úÖ [MATRIX] SHOWING THANK YOU OVERLAY!');
                                // Mark this specific donation click as shown
                                localStorage.setItem(shownKey, 'true');
                                
                                // Clean up old shown markers (older than 1 hour)
                                cleanupOldDonationMarkers();
                                
                                // Show the thank you overlay
                                showThankYouOverlay(data.type);
                                
                                // Also show the donation modal immediately (behind the Matrix overlay)
                                console.log('Also showing donation modal behind Matrix overlay');
                                if (typeof window.showDonationModal === 'function') {
                                    window.showDonationModal();
                                } else {
                                    // Fallback if function not yet available
                                    const modal = document.getElementById('donationModal');
                                    if (modal) {
                                        modal.style.display = 'flex';
                                    }
                                }
                            } else {
                                console.log('Already shown this donation');
                            }
                        } else {
                            console.log('Donation too old');
                        }
                        
                        // Clear the click data after showing (but preserve for future multiple checks)
                        localStorage.removeItem('ddcDonationClick');
                    } catch (e) {
                        // Clean up invalid data
                        localStorage.removeItem('ddcDonationClick');
                    } finally {
                        isProcessingDonationReturn = false;
                    }
                } else {
                    isProcessingDonationReturn = false;
                }
            }
            
            function cleanupOldDonationMarkers() {
                const oneHourAgo = Date.now() - (60 * 60 * 1000);
                const keysToRemove = [];
                let totalCleaned = 0;
                
                // Find old donation markers and other DDC data
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key) {
                        // Clean old donation markers
                        if (key.startsWith('ddcDonationShown_')) {
                            const timestamp = parseInt(key.replace('ddcDonationShown_', ''));
                            if (isNaN(timestamp) || timestamp < oneHourAgo) {
                                keysToRemove.push(key);
                                totalCleaned++;
                            }
                        }
                        // Also clean any malformed DDC keys
                        else if (key.startsWith('ddc') && key.includes('undefined')) {
                            keysToRemove.push(key);
                            totalCleaned++;
                        }
                    }
                }
                
                // Remove old markers
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                if (totalCleaned > 0) {
                    console.log(`Cleaned ${totalCleaned} old localStorage entries`);
                }
            }
            
            function showThankYouOverlay(donationType) {
                console.info('üöÄ [MATRIX] showThankYouOverlay called with type:', donationType);
                showMatrixTerminal();
            }
            
            // Make function globally available for testing
            window.checkForDonationReturn = checkForDonationReturn;
            
            // Check on page load
            checkForDonationReturn();
            
            // Check when window gets focus (user returns from donation page)
            window.addEventListener('focus', function() {
                console.info('üëÅÔ∏è [MATRIX] Window focus event triggered');
                // Small delay to ensure page is fully focused
                setTimeout(checkForDonationReturn, 500);
            });
            
            // Check on visibility change (better detection for modern browsers)
            document.addEventListener('visibilitychange', function() {
                console.info('üëÅÔ∏è [MATRIX] Visibility change event triggered, hidden:', document.hidden);
                if (!document.hidden) {
                    setTimeout(checkForDonationReturn, 500);
                }
            });
            
            // Additional periodic check for new tab scenarios
            // Check every 5 seconds if there's a pending donation click
            setInterval(function() {
                const donationData = localStorage.getItem('ddcDonationClick');
                if (donationData) {
                    try {
                        const data = JSON.parse(donationData);
                        const timeSinceClick = Date.now() - data.timestamp;
                        // If donation was clicked within last 60 minutes and no processing in progress
                        if (timeSinceClick < 60 * 60 * 1000 && !isProcessingDonationReturn) {
                            const shownKey = `ddcDonationShown_${data.timestamp}`;
                            // Only check if not already shown
                            if (!localStorage.getItem(shownKey)) {
                                console.info('üîÑ [MATRIX] Periodic check found pending donation - checking for return');
                                checkForDonationReturn();
                            } else {
                                console.info('üîÑ [MATRIX] Periodic check: donation already shown');
                            }
                        }
                    } catch (e) {
                        // Invalid data, clean up
                        localStorage.removeItem('ddcDonationClick');
                    }
                }
            }, 5000); // Check every 5 seconds
            
            // Auto-close after 8 seconds OR click overlay to close immediately
            let autoCloseTimer = null;
            
            function closeThankYou() {
                if (autoCloseTimer) {
                    clearTimeout(autoCloseTimer);
                    autoCloseTimer = null;
                }
                thankYouOverlay.style.animation = 'thankYouFadeOut 0.5s ease-out';
                setTimeout(() => {
                    thankYouOverlay.style.display = 'none';
                    thankYouOverlay.style.animation = '';
                    console.log('Matrix Thank You closed, donation modal should already be visible');
                    // Modal should already be open, just focus on input
                    const amountInput = document.getElementById('donationAmount');
                    if (amountInput) {
                        amountInput.focus();
                        console.log('Amount input focused');
                    }
                }, 500);
            }
            
            // Click overlay to close immediately
            thankYouOverlay.addEventListener('click', closeThankYou);
            
            // Auto-close after 8 seconds if no interaction
            thankYouOverlay.addEventListener('animationend', function(e) {
                if (e.animationName === 'thankYouFadeIn') {
                    autoCloseTimer = setTimeout(closeThankYou, 8000);
                }
            });
        });
        
        // Matrix Terminal Animation
        
        function showMatrixTerminal() {
            console.info('üé¨ [MATRIX] showMatrixTerminal called');
            const overlay = document.getElementById('thankYouOverlay');
            const textElement = document.getElementById('thankYouText');
            
            console.info('üé¨ [MATRIX] Matrix overlay:', overlay);
            console.info('üé¨ [MATRIX] Matrix text element:', textElement);
            
            if (!overlay || !textElement) {
                console.error('üé¨ [MATRIX] Matrix elements not found!');
                return;
            }
            
            // Show overlay
            overlay.style.display = 'flex';
            textElement.innerHTML = '';
            
            // Timeline: 10 seconds total
            // 0-2s: Cursor blinks
            // 2-4s: Type "Thank You!"
            // 4-6s: Cursor blinks alone 
            // 6-8s: Type "You rule!"
            // 8-10s: Cursor blinks alone
            // 10s: Close
            
            setTimeout(() => {
                typeText(textElement, 'Thank You!', 100, () => {
                    setTimeout(() => {
                        textElement.innerHTML += ' ';
                        typeText(textElement, 'You rule!', 100, () => {
                            setTimeout(() => {
                                overlay.style.display = 'none';
                                textElement.innerHTML = '';
                            }, 2000); // Wait 2s then close
                        });
                    }, 2000); // Wait 2s between messages
                });
            }, 2000); // Wait 2s before first message
        }
        
        function typeText(element, text, speed, callback) {
            let i = 0;
            const timer = setInterval(() => {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                } else {
                    clearInterval(timer);
                    if (callback) callback();
                }
            }, speed);
        }
        
        // Donator Heart Management
        function updateDonatorHeart(donationTimestamp) {
            // No longer storing locally - server handles it
            // Just refresh the mech status from server
            // Use new efficient Power system instead
            syncWithServer();
        }
        
        // Speed description function (simplified version of Python speed_levels.py)
        function getSpeedDescription(level) {
            const speeds = {
                0: {text: "OFFLINE", color: "#888888"},
                1: {text: "Motionless", color: "#4a4a4a"},
                2: {text: "Barely perceptible", color: "#525252"},
                3: {text: "Extremely sluggish", color: "#5a5a5a"},
                4: {text: "Painfully hesitant", color: "#626262"},
                5: {text: "Excruciatingly lethargic", color: "#6a6a6a"},
                10: {text: "Glacially slow", color: "#929292"},
                15: {text: "Faltering pace", color: "#bababa"},
                20: {text: "Slow but continuous", color: "#e2e2e2"},
                25: {text: "Measured walking", color: "#ccaa00"},
                30: {text: "Decisive stride", color: "#88cc00"},
                35: {text: "Fast stride", color: "#33cc00"},
                40: {text: "Quick-paced", color: "#00cc22"},
                45: {text: "Hurrying intensely", color: "#00cc77"},
                50: {text: "Sharply swift", color: "#00cccc"},
                55: {text: "Racing step", color: "#0077cc"},
                60: {text: "Almost running", color: "#0022cc"},
                65: {text: "Fast jogging", color: "#3300cc"},
                70: {text: "Rapid running", color: "#8800cc"},
                75: {text: "Relentless sprint", color: "#cc00bb"},
                80: {text: "Supersonic pace", color: "#cc0066"},
                85: {text: "Breakneck velocity", color: "#cc0011"},
                90: {text: "Star-chasing speed", color: "#ff3300"},
                95: {text: "Warp-level 5", color: "#ff8800"},
                100: {text: "Beyond-lightspeed", color: "#ffdd00"},
                101: {text: "Godspeed", color: "#ffff00"}
            };
            
            // Find the closest level match
            let bestMatch = speeds[0];
            for (let speedLevel in speeds) {
                if (level >= parseInt(speedLevel)) {
                    bestMatch = speeds[speedLevel];
                }
            }
            
            return bestMatch;
        }
        
        // Animation cache - persistent across page reloads
        let lastAnimationPowerLevel = localStorage.getItem('ddcLastAnimationPowerLevel') ? 
            parseInt(localStorage.getItem('ddcLastAnimationPowerLevel')) : null;
        
        // ===================================================================
        // POWER SYSTEM v3.0 - Ultra-Efficient Client-Server Hybrid
        // ===================================================================
        // Performance: 100 DOM updates/day, 60 API calls/hour (99% reduction)
        // ===================================================================
        
        // Configuration
        const POWER_CONFIG = {
            DECAY_RATE: 1 / 86400,           // Default: 1 Power per day (in seconds) - updated dynamically
            UPDATE_PRECISION: 0.01,          // Update display on 0.01 changes
            CLIENT_CHECK_INTERVAL: 10000,    // Check every 10 seconds
            SERVER_SYNC_INTERVAL: 60000,     // Sync with server every 60 seconds
            DONATION_THRESHOLD: 0.5          // Detect donations > $0.50
        };
        
        // State management
        const PowerState = {
            serverPower: 0,                   // Last known server Power value
            serverTime: Date.now(),          // When we got server value
            lastDisplayDecimal: null,        // Last displayed decimal value
            lastAnimationLevel: null,        // Last animation integer level
            serverData: null                 // Full server response data
        };
        
        // ===================================================================
        // INITIALIZATION
        // ===================================================================
        
        (function initializePowerSystem() {
            console.log('[POWER v3.0] Initializing ultra-efficient Power system');
            
            // Clear any old intervals from previous page loads
            const maxInterval = setInterval(() => {}, 0);
            for (let i = 0; i < maxInterval; i++) clearInterval(i);
            
            // Start the system
            loadInitialPowerData();
            
            // Schedule periodic updates
            setInterval(updateClientSidePower, POWER_CONFIG.CLIENT_CHECK_INTERVAL);
            setInterval(syncWithServer, POWER_CONFIG.SERVER_SYNC_INTERVAL);
            
            // Expose global update function for external triggers
            window.forcePowerUpdate = function() {
                console.log('[POWER v3.0] Force update triggered');
                PowerState.lastDisplayDecimal = null;
                updateClientSidePower();
                syncWithServer();
            };
        })();
        
        // ===================================================================
        // CORE FUNCTIONS
        // ===================================================================
        
        async function loadInitialPowerData() {
            try {
                const response = await fetch('/api/donation/status');
                const data = await response.json();
                
                PowerState.serverPower = data.current_Power_raw || data.current_Power || 0;
                PowerState.serverTime = Date.now();
                PowerState.serverData = data;
                
                console.log(`[POWER v3.0] Initial load: $${PowerState.serverPower.toFixed(2)}`);
                updatePowerDisplay(PowerState.serverPower);
                updateBarsFromServerData(data);
                
                // Load initial animation immediately (force load)
                const PowerInteger = Math.floor(PowerState.serverPower);
                PowerState.lastAnimationLevel = null; // Force initial load
                updateMechAnimation(PowerInteger);
                
                console.log(`[POWER v3.0] Initial animation loaded for Power level: ${PowerInteger}`);
            } catch (error) {
                console.error('[POWER v3.0] Initial load failed:', error);
            }
        }
        
        function updateClientSidePower() {
            const now = Date.now();
            const elapsedSeconds = (now - PowerState.serverTime) / 1000;
            
            // Calculate current Power with decay
            const decayAmount = elapsedSeconds * POWER_CONFIG.DECAY_RATE;
            const currentPower = Math.max(0, PowerState.serverPower - decayAmount);
            
            // Only update display if decimal changed
            const currentDecimal = Math.floor(currentPower * 100) / 100;
            if (PowerState.lastDisplayDecimal !== currentDecimal) {
                PowerState.lastDisplayDecimal = currentDecimal;
                updatePowerDisplay(currentPower);
                
                // Also update NEXT bar with local calculation
                updateNextBarLocal(currentPower);
                
                // Check for animation update (integer change)
                const PowerInteger = Math.floor(currentPower);
                if (PowerState.lastAnimationLevel !== PowerInteger) {
                    PowerState.lastAnimationLevel = PowerInteger;
                    updateMechAnimation(PowerInteger);
                }
            }
        }
        
        async function syncWithServer() {
            try {
                const response = await fetch('/api/donation/status');
                const data = await response.json();

                // Update decay rate from server (level-specific)
                if (data.decay_per_day !== undefined) {
                    POWER_CONFIG.DECAY_RATE = data.decay_per_day / 86400;  // Convert per-day to per-second
                    console.log(`[POWER v3.0] Decay rate updated: ${data.decay_per_day}/day (${POWER_CONFIG.DECAY_RATE.toFixed(8)}/s)`);
                }

                const serverPower = data.current_Power_raw || data.current_Power || 0;
                const expectedPower = PowerState.serverPower - ((Date.now() - PowerState.serverTime) / 1000 * POWER_CONFIG.DECAY_RATE);
                const difference = Math.abs(serverPower - expectedPower);
                
                // Always update bars with server calculations
                updateBarsFromServerData(data);
                
                // Sync Power if significant difference detected (new donation)
                if (difference > POWER_CONFIG.DONATION_THRESHOLD) {
                    console.log(`[POWER v3.0] Donation detected: $${PowerState.serverPower.toFixed(2)} ‚Üí $${serverPower.toFixed(2)}`);
                    PowerState.serverPower = serverPower;
                    PowerState.serverTime = Date.now();
                    PowerState.lastDisplayDecimal = null;
                    PowerState.serverData = data;
                }
            } catch (error) {
                // Silent fail to avoid console spam
            }
        }
        
        function updatePowerDisplay(powerAmount) {
            // Simple display update - all complex calculations come from server
            const powerAmountEl = document.getElementById('powerAmount');
            if (powerAmountEl) {
                powerAmountEl.textContent = `${powerAmount.toFixed(2)}`;
            }
            
            // For bars, we need the full server data, not just Power amount
            // This will be updated when we get server response
        }
        
        function updateNextBarLocal(powerAmount) {
            // There is no NEXT bar in HTML - this function does nothing currently
            // The Evolution bar shows progress to next evolution level, not next dollar
            // If we want a "next dollar" bar, we need to add it to the HTML
        }
        
        function updateBarsFromServerData(data) {
            // Use ACTUAL server calculations from MechService
            const powerLevel = document.getElementById('powerLevel');
            const evolutionProgress = document.getElementById('evolutionProgress');
            const nextEvolutionName = document.getElementById('nextEvolutionName');
            const nextEvolutionAmount = document.getElementById('nextEvolutionAmount');
            const speedStatusOverlay = document.getElementById('speedStatusOverlay');
            
            // Update POWER Bar using server's bar calculations
            if (powerLevel && data.bars) {
                const percentage = (data.bars.Power_current / data.bars.Power_max_for_level) * 100;
                powerLevel.style.width = `${Math.min(100, percentage)}%`;
                
                // Color based on actual Power amount
                const Power = data.current_Power_raw || data.current_Power || 0;
                if (Power >= 500) {
                    powerLevel.style.background = 'linear-gradient(90deg, #00ffff 0%, #0099ff 50%, #00ffff 100%)';
                } else if (Power >= 250) {
                    powerLevel.style.background = 'linear-gradient(90deg, #00ff00 0%, #00dd00 50%, #00ff00 100%)';
                } else if (Power >= 100) {
                    powerLevel.style.background = 'linear-gradient(90deg, #ffcc00 0%, #ff9900 50%, #ffcc00 100%)';
                } else if (Power >= 50) {
                    powerLevel.style.background = 'linear-gradient(90deg, #ff6600 0%, #ff3300 50%, #ff6600 100%)';
                } else {
                    powerLevel.style.background = 'linear-gradient(90deg, #cc0000 0%, #990000 50%, #cc0000 100%)';
                }
            }
            
            // Update Evolution Bar (the "NEXT" bar for evolution progress)
            if (evolutionProgress && data) {
                // Use server data for evolution progress
                if (data.bars && data.bars.mech_progress_current !== undefined && data.bars.mech_progress_max !== undefined) {
                    const percentage = (data.bars.mech_progress_current / data.bars.mech_progress_max) * 100;
                    evolutionProgress.style.width = `${Math.min(100, percentage)}%`;
                }
                
                // Update evolution text
                if (nextEvolutionName && nextEvolutionAmount) {
                    const currentLevel = data.mech_level || 1;

                    // Check if we're at MAX LEVEL (Level 11)
                    if (currentLevel >= 11) {
                        nextEvolutionName.textContent = "MAX EVOLUTION REACHED";
                        nextEvolutionAmount.textContent = "üåü OMEGA MECH ACHIEVED";
                    } else {
                        // Get next evolution name based on current level
                        const evolutionNames = [
                            "SCRAP MECH", "REPAIRED MECH", "STANDARD MECH", "ENHANCED MECH",
                            "ADVANCED MECH", "ELITE MECH", "CYBER MECH", "PLASMA MECH",
                            "QUANTUM MECH", "DIVINE MECH", "OMEGA MECH"
                        ];

                        if (currentLevel < evolutionNames.length) {
                            nextEvolutionName.textContent = evolutionNames[currentLevel]; // Next level name
                        }

                        // Update amount needed
                        if (data.bars && data.bars.mech_progress_max !== undefined) {
                            const currentProgress = data.bars.mech_progress_current || 0;
                            const maxProgress = data.bars.mech_progress_max || 0;
                            const needed = Math.max(0, maxProgress - currentProgress);
                            nextEvolutionAmount.textContent = `$${needed.toFixed(2)} needed`;
                        }
                    }
                }
            }

            // Update Speed Status based on mech level and power
            if (speedStatusOverlay && data) {
                const currentLevel = data.mech_level || 1;
                const currentPower = data.current_Power_raw || data.current_Power || 0;

                // For Level 11 (OMEGA MECH), show special status
                if (currentLevel >= 11) {
                    speedStatusOverlay.textContent = "REALITY BENDING";
                    speedStatusOverlay.style.color = "#ff00ff";
                    speedStatusOverlay.style.textShadow = "0 0 10px #ff00ff";
                } else {
                    // Use backend API for accurate speed calculation instead of flawed Math.floor
                    if (data && data.speed) {
                        // Use speed info from API response (includes correct power ratio calculation)
                        speedStatusOverlay.textContent = data.speed.description;
                        speedStatusOverlay.style.color = data.speed.color;
                        speedStatusOverlay.style.textShadow = "none";
                    } else {
                        // Fallback for missing speed data - fetch from API
                        fetch('/api/donation/status')
                            .then(response => response.json())
                            .then(apiData => {
                                if (apiData && apiData.speed) {
                                    speedStatusOverlay.textContent = apiData.speed.description;
                                    speedStatusOverlay.style.color = apiData.speed.color;
                                    speedStatusOverlay.style.textShadow = "none";
                                } else {
                                    // Final fallback: Use simple 1:1 mapping (1 Power = 1 Speed Level)
                                    // This is not evolution-aware but better than nothing
                                    const glvl = currentPower <= 0 ? 0 : Math.max(1, Math.min(100, Math.floor(currentPower)));
                                    const speedInfo = getSpeedDescription(glvl);
                                    speedStatusOverlay.textContent = speedInfo.text;
                                    speedStatusOverlay.style.color = speedInfo.color;
                                    speedStatusOverlay.style.textShadow = "none";
                                }
                            })
                            .catch(() => {
                                // Final fallback: Use simple 1:1 mapping (1 Power = 1 Speed Level)
                                // This is not evolution-aware but better than nothing
                                const glvl = currentPower <= 0 ? 0 : Math.max(1, Math.min(100, Math.floor(currentPower)));
                                const speedInfo = getSpeedDescription(glvl);
                                speedStatusOverlay.textContent = speedInfo.text;
                                speedStatusOverlay.style.color = speedInfo.color;
                                speedStatusOverlay.style.textShadow = "none";
                            });
                    }
                }
            }
        }
        
        function updateMechAnimation(PowerInteger) {
            const mechImg = document.getElementById('donatorMechAnimation');
            if (mechImg) {
                // Cache key for localStorage
                const cacheKey = `ddcMechAnimation_${PowerInteger}`;
                const lastLevel = localStorage.getItem('ddcLastAnimationPowerLevel');
                
                // Force reload if no previous level stored OR level changed
                if (lastLevel === null || lastLevel !== PowerInteger.toString()) {
                    mechImg.src = `/mech_animation?t=${Date.now()}`;
                    localStorage.setItem('ddcLastAnimationPowerLevel', PowerInteger.toString());
                    console.log(`[POWER] Animation updated for Power level: ${PowerInteger} (was: ${lastLevel || 'none'})`);
                } else {
                    console.log(`[POWER] Animation unchanged for Power level: ${PowerInteger}`);
                }
            } else {
                console.error('[POWER] Mech animation element not found!');
            }
        }
        
        // Consume Power every 3 seconds (backend only, no Next Bar animation)
        function consumePower() {
            const powerAmount = document.getElementById('powerAmount');
            
            if (powerAmount) {
                // Parse current Power amount
                const currentPower = parseFloat(powerAmount.textContent.replace('$', ''));
                
                // Only consume Power if we have Power
                if (currentPower > 0) {
                    // Actually consume Power on server
                    fetch('/api/donation/consume-Power', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            amount: 0.00003472  // Exact amount for 1$ per day
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update display with new amount
                            powerAmount.textContent = '$' + data.new_Power.toFixed(2);
                            
                            // If Power hits 0, refresh mech animation
                            if (data.new_Power <= 0) {
                                setTimeout(() => {
                                    // Use new efficient Power system instead
                            syncWithServer();
                                }, 1500);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error consuming Power:', error);
                    });
                }
            }
        }
        
        // OLD: Power consumption moved to efficient client-side system above
        // setInterval(consumePower, 3000); // DISABLED - using client-side calculation
        
        // Flash consumption overlay with fade animation every 3 seconds (only if Power > 0)
        function flashConsumptionOverlay() {
            const overlay = document.getElementById('powerConsumptionOverlay');
            const powerAmount = document.getElementById('powerAmount');
            
            if (overlay && powerAmount) {
                // Parse current Power amount
                const currentPower = parseFloat(powerAmount.textContent.replace('$', ''));
                
                // Only show consumption animation if we have Power
                if (currentPower > 0) {
                    overlay.style.transition = 'opacity 0.3s ease-in';
                    overlay.style.opacity = '1';
                    
                    // Hide after 1 second (same timing as Next Bar)
                    setTimeout(() => {
                        overlay.style.transition = 'opacity 0.5s ease-out';
                        overlay.style.opacity = '0';
                    }, 1000);
                }
            }
        }
        
        // OLD: Consumption overlay moved to efficient client-side system
        // setInterval(flashConsumptionOverlay, 3000); // DISABLED - using client-side calculation
        
        // Donation Modal Functions
        function showDonationModal() {
            const modal = document.getElementById('donationModal');
            if (modal) {
                // Prevent double-opening
                if (modal.style.display === 'flex') {
                    return;
                }
                
                modal.style.display = 'flex';
                // Focus on amount input
                setTimeout(() => {
                    const amountInput = document.getElementById('donationAmount');
                    if (amountInput) {
                        amountInput.focus();
                    }
                }, 100);
            }
        }
        
        // Make modal functions globally available
        window.showDonationModal = showDonationModal;
        
        function closeDonationModal() {
            const modal = document.getElementById('donationModal');
            if (modal) {
                modal.style.display = 'none';
                // Reset form
                document.getElementById('donationForm').reset();
                document.getElementById('publishToDiscord').checked = true; // Default to checked
            }
        }
        
        function submitDonation() {
            const amountInput = document.getElementById('donationAmount');
            const donorNameInput = document.getElementById('donorName');
            const publishCheckbox = document.getElementById('publishToDiscord');
            
            // Check if elements exist
            if (!amountInput || !donorNameInput || !publishCheckbox) {
                alert('Error: Form elements not found. Please try again.');
                return;
            }
            
            const amount = amountInput.value.trim();
            const donorName = donorNameInput.value.trim() || 'Anonymous';
            const publishToDiscord = publishCheckbox.checked;
            
            // Enhanced amount validation
            if (!amount) {
                alert('Please enter a donation amount.');
                amountInput.focus();
                return;
            }
            
            const parsedAmount = parseFloat(amount);
            if (isNaN(parsedAmount) || parsedAmount <= 0) {
                alert('Please enter a valid positive donation amount.');
                amountInput.focus();
                return;
            }
            
            if (parsedAmount > 999999) {
                alert('Maximum donation amount is $999,999.');
                amountInput.focus();
                return;
            }
            
            // Validate donor name length
            if (donorName.length > 50) {
                alert('Donor name must be 50 characters or less.');
                donorNameInput.focus();
                return;
            }
            
            // Disable submit button to prevent double-submission
            const submitBtn = document.querySelector('button[onclick="submitDonation()"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = '‚è≥ Processing...';
            }
            
            // Helper function to re-enable button
            function resetSubmitButton() {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üöÄ ‚ö° Power the Mech!';
                }
            }
            
            // Prepare donation data
            const donationData = {
                amount: parseFloat(amount),
                donor_name: donorName,
                publish_to_discord: publishToDiscord,
                source: 'web_ui_manual'
            };
            
            // Debug: Log what we're sending
            console.log('üîç DONATION DEBUG: Sending data:', donationData);
            console.log('üîç DONATION DEBUG: publish_to_discord =', publishToDiscord, '(type:', typeof publishToDiscord, ')');
            
            // Submit donation to server with timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
            
            fetch('/api/donation/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(donationData),
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Reset button first
                    resetSubmitButton();
                    
                    // Close modal
                    closeDonationModal();
                    
                    // Refresh mech status to show new Power
                    // Use new efficient Power system instead
            syncWithServer();
                    
                    // Show success message
                    showSuccessMessage(`üöÄ Thank you ${donorName}! $${amount} added to mech Power!`);
                } else {
                    alert('Error processing donation: ' + (data.error || 'Unknown error'));
                    resetSubmitButton();
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                console.error('Error submitting donation:', error);
                
                // Better error messages for users
                let userMessage = 'Error submitting donation. Please try again.';
                if (error.name === 'AbortError') {
                    userMessage = 'Request timeout. Please check your connection and try again.';
                } else if (error.message.includes('HTTP')) {
                    userMessage = `Server error: ${error.message}. Please try again later.`;
                } else if (!navigator.onLine) {
                    userMessage = 'No internet connection. Please check your connection.';
                }
                
                alert(userMessage);
                resetSubmitButton();
            });
        }
        
        function showSuccessMessage(message) {
            // Create temporary success message
            const successDiv = document.createElement('div');
            successDiv.innerHTML = `
                <div class="alert alert-success" style="position: fixed; top: 20px; right: 20px; z-index: 3000; animation: slideInRight 0.3s ease;">
                    ${message}
                </div>
            `;
            document.body.appendChild(successDiv);
            
            // Remove after 4 seconds
            setTimeout(() => {
                successDiv.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => document.body.removeChild(successDiv), 300);
            }, 4000);
        }
        
        // Close modal when clicking overlay background
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('donationModal');
            if (event.target === modal) {
                closeDonationModal();
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeDonationModal();
            }
        });
        
        
        
        function showNotification(message, type = 'info') {
            // Create a simple notification (you can style this better)
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
        
        
        // Additional animations for different donation types
        const additionalStyles = `
            @keyframes thankYouFadeOut {
                from { opacity: 1; transform: scale(1); }
                to { opacity: 0; transform: scale(0.9); }
            }
            
            @keyframes thankYouCoffeeShake {
                0%, 100% { transform: rotate(0deg); }
                25% { transform: rotate(-2deg); }
                75% { transform: rotate(2deg); }
            }
            
            @keyframes thankYouPaypalGlow {
                0%, 100% { box-shadow: 0 0 0 rgba(0,112,186,0.5); }
                50% { box-shadow: 0 0 30px rgba(0,112,186,0.8); }
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.textContent = additionalStyles;
        document.head.appendChild(styleSheet);
        
        // Mech Animation Test Functions
        function testMechAnimation() {
            const donorName = document.getElementById('test-donor-name').value;
            const amount = document.getElementById('test-amount').value;
            const totalDonations = document.getElementById('test-total-donations').value;
            
            const preview = document.getElementById('mech-preview');
            const stats = document.getElementById('mech-stats');
            
            preview.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
            stats.innerHTML = 'Generating animation...';
            
            fetch('/api/test-mech-animation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    donor_name: donorName,
                    amount: amount,
                    total_donations: parseInt(totalDonations)
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response type:', response.headers.get('content-type'));
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.blob();
            })
            .then(blob => {
                console.log('Blob size:', blob.size, 'Type:', blob.type);
                const url = URL.createObjectURL(blob);
                preview.innerHTML = `<img src="${url}" alt="Mech Animation" style="max-width: 100%; height: auto; border: 1px solid #666;">`;
                
                // Calculate speed level
                let speedLevel = 1;
                const donations = parseInt(totalDonations);
                if (donations >= 100) speedLevel = 6;
                else if (donations >= 50) speedLevel = 5;
                else if (donations >= 25) speedLevel = 4;
                else if (donations >= 10) speedLevel = 3;
                else if (donations >= 5) speedLevel = 2;
                
                const speedTexts = {
                    1: "Walking",
                    2: "Jogging",
                    3: "Running",
                    4: "Sprinting",
                    5: "Hyperspeed",
                    6: "LIGHTSPEED!"
                };
                
                stats.innerHTML = `
                    <strong>Speed Level:</strong> ${speedLevel}/6 - ${speedTexts[speedLevel]}<br>
                    <strong>File Size:</strong> ~${(blob.size / 1024).toFixed(1)} KB<br>
                    <strong>Type:</strong> ${blob.type}
                `;
            })
            .catch(error => {
                console.error('Mech animation error:', error);
                preview.innerHTML = '<div class="alert alert-danger">Error generating animation: ' + error.message + '<br>Check browser console for details.<br><small>Make sure the spritesheet exists at app/static/animatedmech.png</small></div>';
                stats.innerHTML = 'Error: ' + error.message;
            });
        }
        
        function testSpeedControl() {
            const totalDonations = document.getElementById('test-total-donations').value;
            const preview = document.getElementById('mech-preview');
            const stats = document.getElementById('mech-stats');
            
            // Get speed configuration
            fetch('/api/mech-speed-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    total_donations: parseInt(totalDonations)
                })
            })
            .then(response => response.json())
            .then(data => {
                // Create dynamic mech display
                const mechHtml = `
                    <div class="mech-container position-relative" style="height: 100px; overflow: hidden;">
                        <div class="mech-sprite ${data.css_class}" id="dynamic-mech"
                             style="position: absolute; left: -50px; top: 30px; font-size: 30px; 
                                    animation: mech-run ${data.duration}s linear infinite;">
                            ü§ñ
                        </div>
                        ${data.effects.sparks ? '<div class="sparks">‚ö°‚ö°‚ö°</div>' : ''}
                    </div>
                    <div class="mt-2">
                        <strong>${data.emoji} ${data.description}</strong><br>
                        <small>Speed Level: ${data.speed_level}/6</small>
                    </div>
                `;
                
                preview.innerHTML = mechHtml;
                
                // Add dynamic CSS
                const css = `
                    @keyframes mech-run {
                        0% { left: -50px; }
                        100% { left: calc(100% + 50px); }
                    }
                    
                    .mech-speed-${data.speed_level} {
                        ${data.effects.glow ? 'filter: drop-shadow(0 0 10px #00ff41);' : ''}
                        ${data.effects.blur ? 'filter: blur(0.5px) brightness(1.2);' : ''}
                    }
                    
                    ${data.effects.shake ? `
                        .mech-speed-${data.speed_level} {
                            animation: mech-run ${data.duration}s linear infinite, 
                                      mech-shake 0.1s ease-in-out infinite;
                        }
                        @keyframes mech-shake {
                            0%, 100% { transform: translateY(0); }
                            50% { transform: translateY(2px); }
                        }
                    ` : ''}
                    
                    ${data.effects.sparks ? `
                        .sparks {
                            position: absolute;
                            top: 20px;
                            left: 50%;
                            animation: spark-flash 0.3s ease-in-out infinite;
                            color: #ffff00;
                            font-size: 20px;
                        }
                        @keyframes spark-flash {
                            0%, 100% { opacity: 0; }
                            50% { opacity: 1; }
                        }
                    ` : ''}
                `;
                
                // Add CSS to page
                let styleElement = document.getElementById('dynamic-mech-styles');
                if (styleElement) styleElement.remove();
                
                styleElement = document.createElement('style');
                styleElement.id = 'dynamic-mech-styles';
                styleElement.textContent = css;
                document.head.appendChild(styleElement);
                
                stats.innerHTML = `
                    <strong>Speed:</strong> ${data.description} (${data.duration}s cycle)<br>
                    <strong>Effects:</strong> ${Object.keys(data.effects).filter(k => data.effects[k]).join(', ') || 'None'}<br>
                    <strong>Total Donations:</strong> ${data.total_donations}
                `;
            })
            .catch(error => {
                console.error('Speed control error:', error);
                preview.innerHTML = '<div class="alert alert-danger">Error: ' + error + '<br>Check browser console for details.</div>';
                stats.innerHTML = 'Error occurred';
            });
        }
        
        function testSimpleMech() {
            const totalDonations = document.getElementById('test-total-donations').value;
            const preview = document.getElementById('mech-preview');
            const stats = document.getElementById('mech-stats');
            
            // Calculate speed level locally
            let speedLevel = 1;
            const donations = parseInt(totalDonations);
            if (donations >= 100) speedLevel = 6;
            else if (donations >= 50) speedLevel = 5;
            else if (donations >= 25) speedLevel = 4;
            else if (donations >= 10) speedLevel = 3;
            else if (donations >= 5) speedLevel = 2;
            
            const speedTexts = {
                1: "Walking",
                2: "Jogging", 
                3: "Running",
                4: "Sprinting",
                5: "Hyperspeed",
                6: "LIGHTSPEED!"
            };
            
            // Calculate animation duration (faster = shorter duration)
            const durations = {1: 3.0, 2: 2.0, 3: 1.5, 4: 1.0, 5: 0.6, 6: 0.3};
            const duration = durations[speedLevel];
            
            // Create stationary mech with leg animation
            preview.innerHTML = `
                <div style="position: relative; height: 120px; overflow: hidden; background: linear-gradient(90deg, #2f3136 0%, #36393f 50%, #2f3136 100%); border-radius: 8px;">
                    <!-- Mech Body (stationary) -->
                    <div class="mech-body" style="
                        position: absolute;
                        left: 50%;
                        top: 30px;
                        transform: translateX(-50%);
                        font-size: 40px;
                        animation: mechBob ${duration * 2}s ease-in-out infinite;
                        ${speedLevel >= 5 ? 'filter: drop-shadow(0 0 15px #00ff41) brightness(1.4);' : ''}
                        ${speedLevel >= 6 ? 'text-shadow: 0 0 25px #ffff00; color: gold;' : ''}
                    ">ü§ñ</div>
                    
                    <!-- Walking legs animation -->
                    <div class="mech-legs" style="
                        position: absolute;
                        left: 50%;
                        top: 65px;
                        transform: translateX(-50%);
                        font-size: 20px;
                        animation: mechWalk ${duration}s ease-in-out infinite;
                    ">üë£</div>
                    
                    <!-- Speed effects -->
                    ${speedLevel >= 3 ? `<div class="speed-lines" style="
                        position: absolute;
                        left: 20%;
                        top: 45px;
                        font-size: 16px;
                        animation: speedLines ${duration * 0.5}s linear infinite;
                        color: #7289da;
                    ">üí®üí®üí®</div>` : ''}
                    
                    <!-- Lightning effects for max speed -->
                    ${speedLevel >= 6 ? '<div style="position: absolute; top: 15px; left: 50%; transform: translateX(-50%); font-size: 25px; animation: flash 0.3s ease-in-out infinite; color: #ffff00;">‚ö°Ô∏èüí´‚ö°Ô∏è</div>' : ''}
                </div>
                <div class="mt-2 text-center">
                    <strong>${speedTexts[speedLevel]}</strong><br>
                    <small>Level ${speedLevel}/6 - ${duration}s cycle</small>
                </div>
            `;
            
            // Add animation CSS for stationary mech with moving parts
            const css = `
                @keyframes mechBob {
                    0%, 100% { transform: translateX(-50%) translateY(0px); }
                    50% { transform: translateX(-50%) translateY(-3px); }
                }
                @keyframes mechWalk {
                    0% { transform: translateX(-50%) rotate(-5deg); }
                    25% { transform: translateX(-50%) rotate(0deg); }
                    50% { transform: translateX(-50%) rotate(5deg); }
                    75% { transform: translateX(-50%) rotate(0deg); }
                    100% { transform: translateX(-50%) rotate(-5deg); }
                }
                @keyframes speedLines {
                    0% { opacity: 0; transform: translateX(0px); }
                    50% { opacity: 1; transform: translateX(-10px); }
                    100% { opacity: 0; transform: translateX(-20px); }
                }
                @keyframes flash {
                    0%, 100% { opacity: 0; transform: translateX(-50%) scale(1); }
                    50% { opacity: 1; transform: translateX(-50%) scale(1.1); }
                }
            `;
            
            let styleElement = document.getElementById('simple-mech-styles');
            if (styleElement) styleElement.remove();
            
            styleElement = document.createElement('style');
            styleElement.id = 'simple-mech-styles';
            styleElement.textContent = css;
            document.head.appendChild(styleElement);
            
            stats.innerHTML = `
                <strong>Speed Test:</strong> Pure CSS Animation<br>
                <strong>Donations:</strong> ${donations}<br>
                <strong>No API needed!</strong> ‚úÖ
            `;
        }
        
        function simulateDonationBroadcast() {
            const donorName = document.getElementById('test-donor-name').value;
            const amount = document.getElementById('test-amount').value;
            const totalDonations = document.getElementById('test-total-donations').value;
            
            if (confirm(`This will send a test donation broadcast to Discord.\n\nDonor: ${donorName}\nAmount: ${amount}\n\nContinue?`)) {
                fetch('/api/simulate-donation-broadcast', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        donor_name: donorName,
                        amount: amount,
                        total_donations: parseInt(totalDonations)
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Test broadcast sent successfully!', 'success');
                    } else {
                        showNotification('Error: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    showNotification('Error sending broadcast: ' + error, 'danger');
                });
            }
        }
    </script>

    <p class="text-center" style="color:#ffc107;"><strong>Important:</strong> After saving, the Docker container must be restarted manually (e.g., via Unraid UI or `docker restart ddc`) for the bot to apply all changes!</p>

    {# Flash Messages #}
    {% include '_flash_messages.html' %}

    {# Main form starts here #}
    <form method="POST" id="config-form">

        {# Discord Bot Settings (Token) #}
        {% include '_discord_settings.html' %}

        {# Channel Settings (Guild ID) #}
        {% include '_channel_settings.html' %}

        {# Command Permissions Table #}
        {% include '_permissions_table.html' %}

        {# Server Selection Table #}
        {% include '_server_selection.html' %}

        {# NEW: Task Scheduler Form #}
        <hr class="my-4">
        <div class="mb-3 card p-3">
            {% with active_containers=active_container_names %}
                {% include 'tasks/form.html' %}
            {% endwith %}
        </div>

        {# NEW: Task Scheduler List #}
        <hr class="my-4">
        <div class="mb-3 card p-3">
             {% with active_containers=active_container_names %}
                 {% include 'tasks/list.html' %}
             {% endwith %}
        </div>

        {# Scheduler Section - OLD, replaced by tasks/form.html #}
        {# {% include '_scheduler_section.html' %} #}

        {# Language and Timezone Settings #}
        {% include '_language_timezone_settings.html' %}


        {# NEW: Auth Settings #}
        {% include '_auth_settings.html' %}

        {# Save Button #}
        {% include '_save_button.html' %}

    </form> {# --- End of form --- #}

    {# Heartbeat Section - MOVED OUTSIDE FORM #}
    {% include '_heartbeat_section.html' %}

    <div id="save-notification"></div>

    {% include '_log_section.html' %}

    
    {# Modals #}
    {% include '_spam_protection_modal.html' %}
    {% include '_token_security_modal.html' %}
    {% include '_secure_token_modal.html' %}
    {% include '_advanced_settings_modal.html' %}
    {% include '_diagnostics_modal.html' %}
    {% include '_donation_management_modal.html' %}

{% endblock %} {# --- End content block --- #}

{% block scripts %}
    {% include '_scripts.html' %}
{% endblock %} {# --- End scripts block --- #}